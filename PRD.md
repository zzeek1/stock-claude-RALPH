# 股票交易日志与复盘分析系统 PRD

## 一、产品概述

### 1.1 产品定位
一款面向低频交易员（每天1-3笔交易）的本地桌面应用，帮助用户记录股票交易、统计分析、AI智能复盘，提升交易纪律性和决策质量。

### 1.2 目标用户
- 个人股票投资者
- 低频交易员
- 重视交易纪律和复盘的投资者
- 需要量化交易表现的从业者

### 1.3 核心价值
- **数据驱动**：量化交易表现，客观评估策略有效性
- **AI赋能**：Claude AI 提供专业交易教练式复盘分析
- **隐私保护**：本地存储，数据不离开用户设备
- **简单易用**：低频交易场景优化，减少操作负担

---

## 二、技术架构

### 2.1 技术栈
| 层级 | 选型 |
|------|------|
| 桌面框架 | Electron 33 |
| 前端 | React 18 + TypeScript |
| UI组件库 | Ant Design 5 |
| 图表 | Recharts 2 |
| 数据库 | sql.js (WASM SQLite) |
| AI | Anthropic SDK (Claude API) |
| 实时行情 | Longbridge SDK |
| 构建 | Vite 6 + electron-builder |
| 状态管理 | Zustand 5 |
| 路由 | react-router-dom 6 |

### 2.2 系统架构
```
┌─────────────────────────────────────────────────────────────┐
│                     渲染进程 (React)                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │Dashboard│ │TradeLog │ │Positions│ │AIReview │ ...       │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       └───────────┴───────────┴───────────┘                │
│                         │ window.electronAPI                │
└─────────────────────────┼───────────────────────────────────┘
                          │ IPC (contextBridge)
┌─────────────────────────┼───────────────────────────────────┐
│                    主进程 (Node.js)                          │
│  ┌──────────────────────┴──────────────────────────────┐   │
│  │                   IPC Handlers                       │   │
│  └──────────────────────┬──────────────────────────────┘   │
│                         │                                   │
│  ┌──────────┐ ┌─────────┴─────────┐ ┌──────────┐           │
│  │ Services │ │   Database Layer  │ │   AI     │           │
│  │ Trade    │ │   sql.js (WASM)   │ │ Claude   │           │
│  │ Stats    │ │   migrate.ts      │ │ Stream   │           │
│  │ Account  │ └───────────────────┘ └──────────┘           │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 数据模型

#### trades 表（交易记录）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| stock_code | TEXT | 股票代码 |
| stock_name | TEXT | 股票名称 |
| market | TEXT | 市场 (SH/SZ/BJ/HK/US) |
| direction | TEXT | 方向 (BUY/SELL) |
| trade_date | TEXT | 交易日期 |
| price | REAL | 成交价格 |
| quantity | INTEGER | 成交数量 |
| amount | REAL | 成交金额 |
| commission | REAL | 佣金 |
| stamp_tax | REAL | 印花税 |
| total_cost | REAL | 总费用 |
| realized_pnl | REAL | 已实现盈亏 |
| strategy | TEXT | 策略标签 |
| emotion_before | TEXT | 交易前情绪 |
| emotion_after | TEXT | 交易后情绪 |
| is_impulsive | INTEGER | 是否冲动交易 |
| entry_reason | TEXT | 入场理由 |
| exit_plan | TEXT | 出场计划 |
| stop_loss | REAL | 止损价 |
| take_profit | REAL | 止盈价 |
| lesson | TEXT | 经验教训 |
| tags | TEXT | 自定义标签 (JSON) |

#### account_snapshots 表（账户快照）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| date | TEXT | 快照日期 |
| total_assets | REAL | 总资产 |
| cash | REAL | 现金 |
| market_value | REAL | 持仓市值 |
| daily_pnl | REAL | 当日盈亏 |
| daily_return | REAL | 当日收益率 |

#### ai_reviews 表（AI复盘记录）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键 |
| review_type | TEXT | 复盘类型 (daily/weekly/monthly) |
| start_date | TEXT | 开始日期 |
| end_date | TEXT | 结束日期 |
| ai_response | TEXT | AI分析结果 |
| user_note | TEXT | 用户笔记 |
| is_favorite | INTEGER | 是否收藏 |

---

## 三、功能模块

### 3.1 首页看板 (Dashboard)

**功能描述**：展示核心交易指标和收益趋势

**核心指标卡片**：
- 总盈亏
- 胜率
- 盈亏比
- 总交易次数

**图表展示**：
- 收益曲线（累计盈亏 + 每日盈亏）
- 月度统计（盈亏柱状图 + 交易次数）

**状态**：✅ 已完成

---

### 3.2 新建交易 (NewTrade)

**功能描述**：记录新的交易记录

**表单字段**：
- 基本信息：股票代码/名称、市场、方向、价格、数量
- 自动计算：成交金额、佣金、印花税、总费用
- 可选信息：策略、入场理由、出场计划、止损/止盈价
- 情绪记录：交易前情绪、交易后情绪、信心程度
- 市场环境：大盘趋势、板块趋势
- 其他：冲动交易标记、标签、经验教训

**特色功能**：
- 股票代码搜索（内置100+常用股票）
- 费用自动计算
- 快速模式（仅填写核心信息）

**状态**：✅ 已完成

---

### 3.3 交易日志 (TradeLog)

**功能描述**：查看和管理所有交易记录

**筛选条件**：
- 日期范围
- 股票代码/名称
- 交易方向（买入/卖出）
- 策略标签
- 盈亏状态（盈利/亏损）

**列表展示**：
- 分页表格，支持排序
- 盈亏着色（绿色盈利、红色亏损）
- 展开行显示详细信息

**操作功能**：
- 编辑交易记录
- 删除交易记录
- 导出 CSV

**状态**：✅ 已完成

---

### 3.4 当前持仓 (Positions)

**功能描述**：根据交易记录自动计算当前持仓

**计算逻辑**：
- 按股票代码聚合买入/卖出记录
- 计算平均成本、持仓数量
- 通过 Longbridge API 获取实时价格
- 计算浮动盈亏和盈亏比例

**展示字段**：
- 股票代码、名称、市场
- 持仓数量、平均成本
- 当前价格、当前市值
- 浮动盈亏、盈亏比例
- 首次买入日期、最近交易日期、持仓天数

**状态**：✅ 已完成

---

### 3.5 统计分析 (Statistics)

**功能描述**：多维度交易数据分析

**统计指标**（12项）：
1. 总盈亏
2. 总收益率
3. 胜率
4. 盈亏比
5. 总交易次数
6. 最大回撤
7. 平均持仓天数
8. 最大连胜
9. 最大连亏
10. 期望值
11. 冲动交易次数
12. 止损执行率

**图表类型**（7种）：
1. 收益曲线（折线图）
2. 盈亏分布（柱状图）
3. 策略对比（分组柱状图）
4. 情绪分析（双轴柱状图）
5. 月度收益（柱状图）
6. 最大回撤（面积图）
7. 日历热力图（自定义组件）

**状态**：✅ 已完成

---

### 3.6 AI 复盘 (AIReview)

**功能描述**：使用 Claude AI 进行智能复盘分析

**复盘类型**：
- 日复盘：分析当天交易
- 周复盘：分析本周交易
- 月复盘：分析本月交易
- 自定义：选择日期范围

**AI 分析框架**：
1. 交易概览：统计数据汇总
2. 核心发现：最重要的发现
3. 错误模式识别：反复出现的问题
4. 做得好的地方：正面强化
5. 行动计划：具体改进建议

**特色功能**：
- 流式输出（实时显示分析过程）
- 历史记录查看
- 收藏功能
- 用户笔记

**状态**：✅ 已完成

---

### 3.7 系统设置 (Settings)

**功能描述**：配置系统参数

**设置项**：
- 外观：深色模式开关
- 账户：初始资金、默认佣金率、印花税率
- AI：API Key（加密存储）、模型选择
- 实时行情：Longbridge API 配置
- 自定义选项：策略列表、标签列表
- 账户快照：手动添加、自动生成
- 数据备份：导出/恢复数据库
- 股票代码：CSV 导入

**状态**：✅ 已完成

---

### 3.8 首次使用向导 (Wizard)

**功能描述**：引导新用户完成初始配置

**步骤**：
1. 设置初始资金
2. 设置交易费率
3. 配置 AI API（可选）
4. 完成设置

**状态**：✅ 已完成

---

## 四、待开发功能

### 4.1 高优先级

#### 4.1.1 交易计划跟踪
**需求描述**：跟踪每笔交易的止损/止盈计划执行情况

**功能点**：
- 在交易录入时设置计划止损价、止盈价
- 卖出时自动检查是否按计划执行
- 统计计划执行率
- AI 复盘时重点分析计划执行情况

**预期价值**：提升交易纪律性，量化执行能力

---

#### 4.1.2 风险评估报告
**需求描述**：生成综合风险评估报告

**功能点**：
- 计算风险敞口（持仓集中度）
- 计算风险收益比
- 评估最大潜在损失
- 提供风险预警

**预期价值**：帮助用户了解风险状况，避免过度集中

---

#### 4.1.3 交易目标管理
**需求描述**：设置和跟踪交易目标

**功能点**：
- 设置月度/年度收益目标
- 设置胜率、盈亏比目标
- 目标达成进度可视化
- 偏离目标时的预警提醒

**预期价值**：增强目标感，提升交易动力

---

### 4.2 中优先级

#### 4.2.1 交易日记
**需求描述**：支持记录与交易相关的日记

**功能点**：
- 每日日记记录
- 与当天交易关联
- 支持富文本编辑
- 日记搜索和筛选
- AI 复盘时参考日记内容

**预期价值**：丰富复盘维度，记录市场感悟

---

#### 4.2.2 策略效果追踪
**需求描述**：长期追踪各策略的表现

**功能点**：
- 策略收益趋势图
- 策略胜率变化
- 策略失效预警
- 策略对比仪表板

**预期价值**：帮助识别有效策略，淘汰无效策略

---

#### 4.2.3 情绪热力图
**需求描述**：真正的情绪-胜率热力图

**功能点**：
- X轴：交易前情绪
- Y轴：交易后情绪
- 颜色：胜率/平均盈亏
- 点击查看具体交易

**预期价值**：直观展示情绪与交易结果的关系

---

#### 4.2.4 交易复盘模板
**需求描述**：支持自定义复盘模板

**功能点**：
- 预设多种复盘模板
- 用户可自定义模板
- 模板分享功能
- AI 使用模板生成报告

**预期价值**：标准化复盘流程，提高效率

---

### 4.3 低优先级

#### 4.3.1 多账户管理
**需求描述**：支持管理多个交易账户

**功能点**：
- 多账户切换
- 账户间数据隔离
- 合并统计视图

**预期价值**：满足多账户用户需求

---

#### 4.3.2 K线图表集成
**需求描述**：在应用内展示股票K线图

**功能点**：
- 集成第三方K线数据
- 标记买卖点
- 技术指标叠加
- 与交易记录联动

**预期价值**：直观查看买卖点位置

---

#### 4.3.3 数据同步
**需求描述**：支持多设备数据同步

**功能点**：
- 云端加密存储
- 多设备同步
- 版本冲突处理

**预期价值**：数据不丢失，多设备使用

---

#### 4.3.4 导出PDF报告
**需求描述**：导出交易统计报告为PDF

**功能点**：
- 自定义报告时间范围
- 选择包含的统计项
- 专业排版输出

**预期价值**：便于存档和分享

---

## 五、技术改进计划

### 5.1 性能优化
- [ ] Vite 代码分割，减少首屏加载时间
- [ ] 虚拟滚动优化大列表
- [ ] 图表渲染优化
- [ ] 数据库查询优化

### 5.2 测试覆盖
- [ ] 单元测试（核心业务逻辑）
- [ ] 集成测试（IPC 通信）
- [ ] E2E 测试（关键用户流程）

### 5.3 安全加固
- [ ] 敏感数据加密存储
- [ ] API Key 安全管理
- [ ] 数据备份加密

### 5.4 用户体验
- [ ] 快捷键支持
- [ ] 更丰富的图表类型
- [ ] 国际化支持
- [ ] 无障碍访问

---

## 六、版本规划

### v1.0（当前版本）
- ✅ 核心交易记录功能
- ✅ 统计分析
- ✅ AI 复盘
- ✅ 实时行情
- ✅ 数据备份

### v1.1（下一版本）
- 交易计划跟踪
- 风险评估报告
- 交易目标管理
- 性能优化

### v1.2
- 交易日记
- 策略效果追踪
- 情绪热力图
- 复盘模板

### v2.0
- 多账户管理
- K线图表集成
- 数据同步
- PDF 报告导出

---

## 七、竞品分析

| 功能 | 本产品 | TradingView | 同花顺 | 雪球 |
|------|--------|-------------|--------|------|
| 本地存储 | ✅ | ❌ | ❌ | ❌ |
| AI 复盘 | ✅ | ❌ | ❌ | ❌ |
| 情绪记录 | ✅ | ❌ | ❌ | ❌ |
| 交易计划 | 部分 | ✅ | ❌ | ❌ |
| 实时行情 | ✅ | ✅ | ✅ | ✅ |
| K线图表 | ❌ | ✅ | ✅ | ✅ |
| 社区功能 | ❌ | ✅ | ✅ | ✅ |

**差异化优势**：
1. 本地存储，隐私保护
2. AI 驱动的专业复盘
3. 情绪维度记录
4. 低频交易场景优化

---

## 八、成功指标

### 8.1 用户指标
- 日活跃用户数
- 平均每用户记录交易数
- AI 复盘使用率

### 8.2 功能指标
- 交易记录完整率（填写可选字段的比例）
- 复盘计划执行率
- 用户留存率

### 8.3 业务指标
- 用户推荐率（NPS）
- 功能满意度评分
- 问题反馈数量

---

## 九、风险与挑战

### 9.1 技术风险
- sql.js 性能限制（大数据量）
- Electron 打包体积较大
- AI API 调用成本

### 9.2 用户风险
- 学习成本（需要理解各种指标）
- 数据迁移困难
- 多平台支持需求

### 9.3 合规风险
- 不提供投资建议
- 数据安全合规
- 第三方 API 使用合规

---

## 十、体验优化方案

### 10.1 交互体验优化

#### 10.1.1 快捷操作
| 功能 | 实现方式 | 优先级 |
|------|----------|--------|
| 快捷键支持 | `Ctrl+N` 新建交易、`Ctrl+S` 保存、`Ctrl+E` 编辑、`Esc` 关闭弹窗 | P0 |
| 快速录入 | 表单字段间 Tab 跳转，回车提交 | P0 |
| 批量操作 | 交易列表多选，批量删除/修改标签 | P1 |
| 记忆功能 | 记住上次选择的策略、股票，自动填充 | P1 |

#### 10.1.2 智能提示
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 价格参考 | 录入时显示最近成交价格或实时价格 | P1 |
| 数量建议 | 根据账户余额提示可买数量 | P2 |
| 风险提示 | 设置止损后自动计算风险敞口 | P1 |
| 重复检测 | 同一天同一股票重复买入时提示确认 | P2 |

---

### 10.2 数据录入增强

#### 10.2.1 历史数据导入
**支持的导入格式**：
| 来源 | 格式 | 字段映射 |
|------|------|----------|
| 同花顺 | CSV/Excel | 自动识别字段 |
| 东方财富 | CSV/Excel | 自动识别字段 |
| 券商APP | CSV | 可配置映射规则 |
| 通用Excel | XLSX/CSV | 用户手动映射 |

**导入流程**：
1. 选择文件
2. 预览数据，自动/手动映射字段
3. 数据校验（必填字段、格式检查）
4. 确认导入，显示导入结果

**优先级**：P0（新用户迁移成本高）

#### 10.2.2 自动数据填充
| 场景 | 自动填充内容 | 优先级 |
|------|--------------|--------|
| 选择股票后 | 自动填入市场、获取实时价格 | P1 |
| 卖出时 | 自动关联买入记录，计算盈亏 | P1 |
| 连续交易 | 继承上一笔交易的策略、标签 | P2 |

#### 10.2.3 交易模板
- 保存常用交易配置（策略、标签、情绪）
- 模板管理（新增、编辑、删除）
- 一键应用模板快速录入

**优先级**：P2

---

### 10.3 AI 功能增强

#### 10.3.1 多模型支持
| 模型 | 用途 | 优先级 |
|------|------|--------|
| Claude (已支持) | 深度复盘分析 | ✅ |
| OpenAI GPT | 备选方案 | P2 |
| 本地模型 | 离线场景、隐私敏感数据 | P3 |

#### 10.3.2 AI 功能扩展
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 实时建议 | 录入交易时 AI 分析入场理由是否合理 | P2 |
| 情绪预警 | 检测到焦虑/恐惧情绪时给出心理建议 | P2 |
| 策略推荐 | 基于历史数据推荐最优策略 | P3 |
| 每日简报 | 每日自动生成交易摘要 | P1 |
| 单笔深度分析 | 针对单笔交易进行深度复盘 | P2 |
| 对话式追问 | 支持与 AI 多轮对话 | P2 |

---

### 10.4 可视化增强

#### 10.4.1 新增图表
| 图表 | 描述 | 优先级 |
|------|------|--------|
| 资产曲线 | 总资产变化趋势（基于账户快照） | P1 |
| 行业分布饼图 | 持仓行业分布 | P2 |
| 时段收益热力图 | 哪个时间段交易效果更好 | P2 |
| 胜率趋势图 | 滚动胜率变化 | P2 |

#### 10.4.2 交互优化
- 图表支持点击钻取查看明细
- 支持图表数据导出为图片
- 支持自定义图表配置（时间范围、指标）

---

### 10.5 提醒与通知

#### 10.5.1 交易提醒
| 提醒类型 | 触发条件 | 优先级 |
|----------|----------|--------|
| 止损提醒 | 价格触及止损位（需行情API） | P1 |
| 止盈提醒 | 价格触及止盈位（需行情API） | P1 |
| 持仓过久提醒 | 持仓超过N天 | P2 |
| 目标进度提醒 | 收益目标进度 | P2 |

#### 10.5.2 复盘提醒
| 提醒类型 | 触发条件 | 优先级 |
|----------|----------|--------|
| 日记提醒 | 每日收盘后提醒填写 | P2 |
| 周复盘提醒 | 周末提醒进行周复盘 | P2 |
| 连续亏损提醒 | 连续N笔亏损提醒暂停交易 | P1 |

---

### 10.6 数据管理增强

#### 10.6.1 数据安全
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 自动备份 | 每日/每周自动备份到本地 | P1 |
| 云备份 | 可选同步到云端（加密） | P2 |
| 版本历史 | 保留多个历史版本，支持回滚 | P2 |

#### 10.6.2 数据分析
| 功能 | 描述 | 优先级 |
|------|------|--------|
| 税务报告 | 自动计算年度盈亏，支持税务申报 | P2 |
| 对账单导出 | 与券商对账 | P3 |
| 数据校验 | 检测异常交易记录 | P3 |

---

## 十一、开发进度跟踪

### 11.1 开发流程
```
需求确认 → 技术设计 → 编码实现 → 单元测试 → 集成测试 → 代码审查 → 发布
```

### 11.2 进度记录方式
- 使用 `.ralph/progress.json` 记录当前任务状态
- 使用 `.ralph/tasks.json` 记录待办任务列表
- 每个功能完成后更新进度

### 11.3 开发优先级总览

#### P0 - 必须完成（v1.1）
| 序号 | 功能 | 预计工时 | 状态 |
|------|------|----------|------|
| 1 | 快捷键支持 | 4h | 待开始 |
| 2 | 历史数据导入 | 8h | 待开始 |

#### P1 - 重要功能（v1.1-v1.2）
| 序号 | 功能 | 预计工时 | 状态 |
|------|------|----------|------|
| 3 | 每日简报 | 6h | 待开始 |
| 4 | 自动数据填充 | 6h | 待开始 |
| 5 | 止损止盈提醒 | 8h | 待开始 |
| 6 | 连续亏损提醒 | 4h | 待开始 |
| 7 | 自动备份 | 4h | 待开始 |
| 8 | 资产曲线图 | 4h | 待开始 |
| 9 | 交易计划跟踪 | 8h | 待开始 |
| 10 | 风险评估报告 | 6h | 待开始 |
| 11 | 交易目标管理 | 6h | 待开始 |

#### P2 - 增强功能（v1.2）
| 序号 | 功能 | 预计工时 | 状态 |
|------|------|----------|------|
| 12 | 交易日记 | 8h | 待开始 |
| 13 | 策略效果追踪 | 6h | 待开始 |
| 14 | 情绪热力图优化 | 4h | 待开始 |
| 15 | AI 多轮对话 | 6h | 待开始 |
| 16 | 云备份 | 8h | 待开始 |

#### P3 - 锦上添花（v2.0）
| 序号 | 功能 | 预计工时 | 状态 |
|------|------|----------|------|
| 17 | 多账户管理 | 12h | 待开始 |
| 18 | K线图表集成 | 16h | 待开始 |
| 19 | PDF 报告导出 | 6h | 待开始 |
| 20 | 本地 AI 模型 | 12h | 待开始 |

---

## 十二、附录

### 10.1 参考资料
- [Electron 官方文档](https://www.electronjs.org/)
- [Ant Design 组件库](https://ant.design/)
- [Claude API 文档](https://docs.anthropic.com/)
- [Longbridge 开放平台](https://open.longbridge.com/)

### 10.2 术语表
| 术语 | 说明 |
|------|------|
| 盈亏比 | 平均盈利金额 / 平均亏损金额 |
| 胜率 | 盈利交易次数 / 总交易次数 |
| 最大回撤 | 峰值到谷值的最大跌幅 |
| 期望值 | (胜率 × 平均盈利) - (败率 × 平均亏损) |
